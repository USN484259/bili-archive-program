<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
</head>
<body>
	<h1 id="title"><a href="/cache/index.html">Cached Videos</a></h1>

	<form id="fetch_form" method="POST" action="/api/video_cache">
		<label for="fetch_bv">Cache new video </label>
		<input name="bvid" id="fetch_bv" autofocus />
	</form>
	<table id="tasklist">
		<thead>
			<tr>
				<th>bvid</th>
				<th>status</th>
				<th>create_time</th>
				<th>start_time</th>
				<th>stop_time</th>
				<th>action</th>
			</tr>
		</thead>
		<tbody>
		</tbody>
	</table>
	<style>
a {
	padding: 4px;
}
span {
	padding: 10px;
}
table {
	width: 100%;
	border-collapse: collapse;
}
thead {
	border: 1px solid;
}
th, td {
	padding: 10px;
}

thead th:nth-child(1) {
	width: 40%;
}
thead th:nth-child(2) {
	width: min(100px, 10%);
}
thead th:nth-child(n+3) {
	width: max(15%, 100px);
}
thead th:last-child {
	width: min(100px, 10%);
}

tbody tr:nth-child(odd) {
	background-color: #cccccc;
}

tbody tr:nth-child(even) {
	background-color: #eeeeee;
}
	</style>
	<script>

const cache_api = document.forms["fetch_form"].action
const cache_root = "/cache/"
const player_url = "/video_page.html";
let localtime = new Intl.DateTimeFormat(undefined, {dateStyle: "medium", timeStyle: "medium"})


function append_time(tr_elem, item, key) {
	let td_elem = document.createElement("td")
	let datetime = item[key]
	if (datetime)
		td_elem.append(localtime.format(new Date(datetime)))

	tr_elem.appendChild(td_elem)
}


function build_tasklist() {
	fetch(cache_api).then((resp) => resp.json()).then((info_table) => {
		console.log(info_table)
		let task_list = info_table.record.concat(info_table.queue).reverse()
		Promise.all(
			task_list.map(
				(task) => fetch(cache_root + task.bvid + "/info.json").then((resp) => resp.json()).catch((err) => {})
			)
		).then((info_list) => {
			console.log(info_list)
			let table_elem = document.getElementById("tasklist")
			let tbody_elem = document.createElement("tbody")
			for (let i = 0; i < task_list.length; i++) {
				let task = task_list[i]
				let info = info_list[i]
				let tr_elem = document.createElement("tr")

				// bvid
				let bvid_elem = document.createElement("td")
				let a_elem = document.createElement("a")
				let bvid = task.bvid
				let url = player_url + "?path=" + cache_root + bvid
				a_elem.setAttribute("href", url)
				try {
					bvid = info.title
				} catch (err) {}
				a_elem.append(bvid)
				bvid_elem.append(a_elem)
				tr_elem.appendChild(bvid_elem)

				// status
				let stat_elem = document.createElement("td")
				stat_elem.append(task.status)
				tr_elem.appendChild(stat_elem)

				append_time(tr_elem, task, "create_time")
				append_time(tr_elem, task, "start_time")
				append_time(tr_elem, task, "stop_time")

				tbody_elem.append(tr_elem)
			}

			let old_tbody = table_elem.getElementsByTagName("tbody")[0]
			table_elem.replaceChild(tbody_elem, old_tbody)
		});
	});
}

document.forms["fetch_form"].addEventListener("submit", (ev) => {
	ev.preventDefault();
	fetch(ev.target.action, {
		method: "POST",
		body: new URLSearchParams(new FormData(ev.target))
	}).then((resp) => {
		ev.target.reset();
		build_tasklist();
	});
});

addEventListener("DOMContentLoaded", () => {
	build_tasklist();
	setInterval(build_tasklist, 10 * 1000);
});
	</script>
</body>
</html>
